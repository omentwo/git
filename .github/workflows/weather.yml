name: Advanced Weather Data Collector

on:
  schedule:
    - cron: '0 0 * * *' # æ¯å¤© UTC æ—¶é—´ 00:00 è¿è¡Œ (å¯¹åº”ä¸Šæµ·æ—¶é—´æ—©ä¸Š8ç‚¹)
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write # éœ€è¦å†™å…¥æƒé™æ¥æäº¤æ–‡ä»¶
  pages: write    # <<< ADDED: Needed to deploy to GitHub Pages
  id-token: write # <<< ADDED: Needed for OIDC token for GitHub Pages deployment

jobs:
  collect-weather:
    runs-on: ubuntu-latest
    env:
      TZ: Asia/Shanghai # ä¸ºæ‰€æœ‰è„šæœ¬è®¾ç½®æ—¶åŒº

    steps:
      # ---------- åŸºç¡€æ­¥éª¤ ----------
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Install dependencies
        run: npm install axios

      # ---------- æ ¸å¿ƒæ•°æ®è·å– ----------
      - name: Run weather script to get data
        id: get-weather
        env:
          AMAP_KEY: ${{ secrets.AMAP_KEY }}
          CITY_ADDRESS: "æµ·å—çœæµ·å£å¸‚ç¼å±±åŒº"
        run: |
          node ./weather.js
          
          # æ£€æŸ¥å½“å¤©çš„æ•°æ®æ–‡ä»¶æ˜¯å¦å·²ç”Ÿæˆ
          TODAY_DATE=$(date +'%Y-%m-%d')
          WEATHER_FILE_PATH="weather-data/${TODAY_DATE}.json"
          if [ -f "$WEATHER_FILE_PATH" ]; then
            echo "âœ… Weather data file found: $WEATHER_FILE_PATH"
            echo "WEATHER_FILE_EXISTS=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ Weather data file NOT found for today: $WEATHER_FILE_PATH"
            echo "WEATHER_FILE_EXISTS=false" >> $GITHUB_OUTPUT
          fi

      # ---------- æ•°æ®æ ¡éªŒ ----------
      - name: Validate weather data file presence
        if: steps.get-weather.outputs.WEATHER_FILE_EXISTS == 'false'
        run: |
          echo "âŒ Critical Error: Today's weather data file was not generated by weather.js."
          echo "Report generation will be skipped or will generate an error report."

      # ---------- æäº¤å¤©æ°”æ•°æ® ----------
      - name: Commit weather data
        if: steps.get-weather.outputs.WEATHER_FILE_EXISTS == 'true'
        run: |
          git config --global user.name "omentwo"
          git config --global user.email "omentwo@users.noreply.github.com"
          git add weather-data/
          if git diff --staged --quiet; then
            echo "â„¹ï¸ No changes in weather data to commit."
          else
            git commit -m "ğŸŒ¤ï¸ æ›´æ–°å¤©æ°”æ•°æ® $(date +'%Y-%m-%d %H:%M %Z')"
            git push
            echo "âœ… Weather data committed."
          fi

      # ---------- ç”Ÿæˆå¤©æ°”æŠ¥å‘ŠHTML ----------
      - name: Generate weather report HTML
        id: generate-html-report
        run: |
          echo "ğŸƒ Running generate_report.js..."
          node generate_report.js
          if [ -f "weather-report.html" ]; then
            echo "âœ… weather-report.html generated."
            echo "REPORT_GENERATED=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ ERROR: weather-report.html was NOT generated by generate_report.js."
            echo "REPORT_GENERATED=false" >> $GITHUB_OUTPUT
          fi

      # ---------- æäº¤å¤©æ°”æŠ¥å‘ŠHTML ----------
      - name: Commit weather report HTML
        run: |
          git config --global user.name "omentwo"
          git config --global user.email "omentwo@users.noreply.github.com"
          git add weather-report.html
          if git diff --staged --quiet; then
            echo "â„¹ï¸ No changes in weather-report.html to commit."
          else
            git commit -m "ğŸ“ˆ æ›´æ–°å¤©æ°”å¯è§†åŒ–æŠ¥å‘Š $(date +'%Y-%m-%d %H:%M %Z')"
            git push
            echo "âœ… Weather report HTML committed."
          fi

      # ---------- è‡ªåŠ¨æ¸…ç†æ—§æ•°æ® ----------
      - name: Clean old weather data files
        run: |
          echo "ğŸ§¹ Cleaning old weather data (older than 30 days)..."
          find weather-data/ -name "*.json" -mtime +30 -print -delete
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add weather-data/
          if git diff --staged --quiet; then
            echo "â„¹ï¸ No old weather data files were deleted, no cleanup commit needed."
          else
            git commit -m "ğŸ—‘ï¸ æ¸…ç†30å¤©å‰å¤©æ°”æ•°æ®"
            git push
            echo "âœ… Cleanup of old data committed."
          fi

      # ---------- ä¸Šä¼  GitHub Pages æ„å»ºäº§ç‰© (è¿™æ˜¯å¯¹ collect-weather job çš„ä¸€ä¸ªå°è¡¥å……) ----------
      - name: Upload Pages artifact (weather-report.html)
        if: steps.generate-html-report.outputs.REPORT_GENERATED == 'true' # ç¡®ä¿æŠ¥å‘Šç”Ÿæˆäº†æ‰ä¸Šä¼ 
        uses: actions/upload-artifact@v4
        with:
          name: github-pages # æ ‡å‡†åç§°ï¼Œdeploy-pages job ä¼šä½¿ç”¨è¿™ä¸ª
          path: weather-report.html # ä¸Šä¼  weather-report.html æ–‡ä»¶
          retention-days: 1 # äº§ç‰©ä¿ç•™1å¤©ï¼Œå› ä¸ºéƒ¨ç½²åå°±ä¸å†éœ€è¦äº†

  # ---------- æ–°å¢ï¼šéƒ¨ç½²åˆ° GitHub Pages çš„ Job ----------
  deploy-pages:
    needs: collect-weather # ä¾èµ– collect-weather job å®Œæˆ
    runs-on: ubuntu-latest

    # å®šä¹‰ GitHub Pages çš„éƒ¨ç½²ç¯å¢ƒ (å¯é€‰ï¼Œä½†æ¨è)
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }} # Action ä¼šè¾“å‡ºéƒ¨ç½²åçš„ URL

    # æ­¤ Job çš„æƒé™å·²åœ¨ workflow çº§åˆ«è®¾ç½® (pages: write, id-token: write)
    # å¦‚æœæ²¡æœ‰åœ¨ workflow çº§åˆ«è®¾ç½®ï¼Œåˆ™éœ€è¦åœ¨è¿™é‡Œå•ç‹¬ä¸º job è®¾ç½®:
    # permissions:
    #   pages: write
    #   id-token: write

    steps:
      - name: Download artifact from collect-weather job
        uses: actions/download-artifact@v4
        with:
          name: github-pages
          # path: . # é»˜è®¤ä¸‹è½½åˆ°å½“å‰å·¥ä½œç›®å½•çš„æ ¹ç›®å½•ï¼Œweather-report.html ä¼šåœ¨æ ¹ç›®å½•

      - name: Setup Pages
        id: pages # ç»™æ­¥éª¤IDä»¥å¤‡åç»­ä½¿ç”¨
        uses: actions/configure-pages@v4
        # æ­¤ action å¯ä»¥é…ç½®è‡ªå®šä¹‰åŸŸåç­‰ï¼Œå¦‚æœä¸éœ€è¦åˆ™æ— éœ€é¢å¤– with å‚æ•°

      - name: Upload artifact for GitHub Pages deployment
        uses: actions/upload-pages-artifact@v3 # æ³¨æ„æ˜¯ upload-pages-artifact
        with:
          # ä¸Šä¼ æ•´ä¸ªå·¥ä½œç›®å½• (å…¶ä¸­åŒ…å«äº†ä¸‹è½½ä¸‹æ¥çš„ weather-report.html)
          # å¦‚æœä½ çš„ weather-report.html éœ€è¦å…¶ä»– css/js/image èµ„æºï¼Œä¸”è¿™äº›èµ„æºä¸ report åœ¨åŒä¸€ç›®å½•æˆ–å­ç›®å½•ï¼Œ
          # ç¡®ä¿å®ƒä»¬ä¹Ÿè¢«æ­£ç¡®ä¸‹è½½æˆ–å­˜åœ¨äºä¸Šä¼ çš„è·¯å¾„ä¸­ã€‚
          # å½“å‰å‡è®¾ weather-report.html æ˜¯è‡ªåŒ…å«çš„ï¼Œæˆ–è€…å®ƒçš„ç›¸å¯¹è·¯å¾„èµ„æºåœ¨ä¸Šä¼ æ—¶ä¹Ÿå­˜åœ¨ã€‚
          path: '.' # å½“å‰å·¥ä½œç›®å½•ï¼Œå…¶ä¸­åº”åŒ…å« weather-report.html

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        # æ­¤ action ä¼šè‡ªåŠ¨æ‰¾åˆ°åä¸º 'github-pages' çš„ç¯å¢ƒå’Œç”± upload-pages-artifact å‡†å¤‡çš„äº§ç‰©
