name: Daily Auto Commit

on:
  schedule:
    - cron: '0 4 * * *'  # UTC 01:00 â†’ åŒ—äº¬ 09:00
    - cron: '0 12 * * *'  # UTC 09:00 â†’ åŒ—äº¬ 17:00
  workflow_dispatch:

permissions:
  contents: write

jobs:
  commit:
    runs-on: ubuntu-latest
    timeout-minutes: 3
    env:
      TZ: Asia/Shanghai

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "omentwo"
          git config user.email "omentwo@users.noreply.github.com"
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}

      - name: Sync and Commit
        run: |
          # åŒæ­¥æœ€æ–°ä»£ç ï¼ˆå¸¦å†²çªè§£å†³ï¼‰
          git pull --rebase origin ${{ github.ref }}
          
          # ç”ŸæˆåŒ—äº¬æ—¶é—´æˆ³
          commit_time=$(date +"%Y-%m-%d %H:%M CST")
          
          # åˆ›å»ºç©ºæäº¤
          git commit --allow-empty \
            -m "chore:ğŸš€ğŸ·ï¸ keep-alive at ${commit_time} [skip ci]" \
            --author="omentwo <omentwo@users.noreply.github.com>"

      - name: Push with Retry
        run: |
          attempts=0
          max_attempts=3
          
          while [ $attempts -lt $max_attempts ]; do
            if git push origin HEAD:${{ github.ref }}; then
              echo "Push successful"
              exit 0
            fi
            
            ((attempts++))
            echo "Attempt $attempts failed, retrying..."
            
            # éšæœºç­‰å¾…1-10ç§’
            sleep $(( RANDOM % 10 + 1 ))
            
            # åŒæ­¥æœ€æ–°ä»£ç 
            git pull --rebase origin ${{ github.ref }}
          done
          
          echo "All push attempts failed"
          exit 1
